# ðŸš€ Secure CI/CD Pipeline for IKU CABALA ACTIVA
# Deploys production-ready static site to GitHub Pages with comprehensive security and validation
name: ðŸŒŸ Production Deployment to GitHub Pages

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["main"]

  # Allows manual triggering from Actions tab
  workflow_dispatch:

# GitHub token permissions for secure deployment
permissions:
  contents: read      # Read repository content
  pages: write        # Deploy to GitHub Pages
  id-token: write     # OIDC token for GitHub Pages deployment

# Prevent concurrent deployments to avoid conflicts
concurrency:
  group: "pages-deployment"
  cancel-in-progress: false

jobs:
  # Build and Deploy Job
  build-and-deploy:
    name: ðŸ—ï¸ Build & Deploy to Production
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest

    steps:
      # ==========================================
      # STEP 1: Checkout Repository
      # ==========================================
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Shallow clone for faster checkout

      # ==========================================
      # STEP 2: Setup Node.js Environment
      # ==========================================
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      # ==========================================
      # STEP 3: Install Dependencies
      # ==========================================
      - name: ðŸ“¦ Install Dependencies
        run: |
          echo "Installing production dependencies..."
          npm ci --prefer-offline --no-audit

          # Ensure critical build dependencies are present
          npm list terser || npm install terser

          echo "âœ… Dependencies installed successfully"

      # ==========================================
      # STEP 4: Environment Variables Validation
      # ==========================================
      - name: ðŸ” Validate Environment Configuration
        run: |
          echo "Validating environment variables..."
          node scripts/verify-env.js
          echo "âœ… Environment validation completed"

      # ==========================================
      # STEP 5: Build Production Static Site
      # ==========================================
      - name: ðŸ”¨ Build Production Site
        env:
          # Site Configuration
          VITE_SITE_URL: ${{ secrets.VITE_SITE_URL || 'https://iku-cabalactiva.com' }}

          # Google Apps Script Integration (CRM)
          VITE_GOOGLE_APP_SCRIPT_URL: ${{ secrets.VITE_GOOGLE_APP_SCRIPT_URL }}
          VITE_WEB_APP_URL: ${{ secrets.VITE_WEB_APP_URL }}

          # Stripe Payment Integration
          VITE_STRIPE_PUBLIC_KEY: ${{ secrets.VITE_STRIPE_PUBLIC_KEY }}
          VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.VITE_STRIPE_PUBLISHABLE_KEY }}
          VITE_STRIPE_CHECKOUT: ${{ secrets.VITE_STRIPE_CHECKOUT }}

          # Stripe Product URLs
          VITE_STRIPE_CARTA_URL: ${{ secrets.VITE_STRIPE_CARTA_URL }}
          VITE_STRIPE_CONSTELACION_URL: ${{ secrets.VITE_STRIPE_CONSTELACION_URL }}
          VITE_STRIPE_MEDITACION_URL: ${{ secrets.VITE_STRIPE_MEDITACION_URL }}
          VITE_STRIPE_LIMPIEZA_URL: ${{ secrets.VITE_STRIPE_LIMPIEZA_URL }}
          VITE_STRIPE_PAQUETE_URL: ${{ secrets.VITE_STRIPE_PAQUETE_URL }}
          VITE_STRIPE_PAQUETE_PARTES_URL: ${{ secrets.VITE_STRIPE_PAQUETE_PARTES_URL }}

          # PayPal Payment Integration
          VITE_PAYPAL_CLIENT_ID: ${{ secrets.VITE_PAYPAL_CLIENT_ID }}
          VITE_PAYPAL_CLIENT_TOKEN: ${{ secrets.VITE_PAYPAL_CLIENT_TOKEN }}
          VITE_PAYPAL_SINGLE_SESSION: ${{ secrets.VITE_PAYPAL_SINGLE_SESSION }}
          VITE_PAYPAL_FULL_PACKAGE: ${{ secrets.VITE_PAYPAL_FULL_PACKAGE }}

          # PayPal Product URLs
          VITE_PAYPAL_CARTA_URL: ${{ secrets.VITE_PAYPAL_CARTA_URL }}
          VITE_PAYPAL_CONSTELACION_URL: ${{ secrets.VITE_PAYPAL_CONSTELACION_URL }}
          VITE_PAYPAL_MEDITACION_URL: ${{ secrets.VITE_PAYPAL_MEDITACION_URL }}
          VITE_PAYPAL_LIMPIEZA_URL: ${{ secrets.VITE_PAYPAL_LIMPIEZA_URL }}
          VITE_PAYPAL_PAQUETE_URL: ${{ secrets.VITE_PAYPAL_PAQUETE_URL }}

          # CRM and Contact Integration
          VITE_CRM_SECRET_TOKEN: ${{ secrets.VITE_CRM_SECRET_TOKEN }}
          VITE_WHATSAPP_NUMBER: ${{ secrets.VITE_WHATSAPP_NUMBER }}
          VITE_GOOGLE_CALENDAR_API_KEY: ${{ secrets.VITE_GOOGLE_CALENDAR_API_KEY }}

          # Email Configuration
          VITE_EMAILJS_SERVICE_ID: ${{ secrets.VITE_EMAILJS_SERVICE_ID }}
          VITE_EMAILJS_TEMPLATE_ID_CONTACT: ${{ secrets.VITE_EMAILJS_TEMPLATE_ID_CONTACT }}
          VITE_EMAILJS_PUBLIC_KEY: ${{ secrets.VITE_EMAILJS_PUBLIC_KEY }}
          VITE_EMAIL_ADMIN: ${{ secrets.VITE_EMAIL_ADMIN }}
          VITE_EMAIL_MAESTRO: ${{ secrets.VITE_EMAIL_MAESTRO }}

          # Google Sheets Integration
          VITE_SPREADSHEET_ID: ${{ secrets.VITE_SPREADSHEET_ID }}
          VITE_DEPLOYMENT_ID: ${{ secrets.VITE_DEPLOYMENT_ID }}

          # Build Settings
          NODE_ENV: production
        run: |
          echo "ðŸ”¨ Building production static site..."
          echo "Environment: production"
          echo "Build tool: Vite"

          # Run the build
          npm run build

          # Verify build output
          if [ ! -d "dist" ]; then
            echo "âŒ Build failed: dist directory not found"
            exit 1
          fi

          if [ ! -f "dist/index.html" ]; then
            echo "âŒ Build failed: index.html not found in dist"
            exit 1
          fi

          # Ensure CNAME file exists for custom domain
          if [ -f "CNAME" ] && [ ! -f "dist/CNAME" ]; then
            echo "ðŸ“ Copying CNAME to dist for custom domain..."
            cp CNAME dist/CNAME
          fi

          echo "âœ… Build completed successfully"
          echo "ðŸ“Š Build artifacts:"
          ls -lh dist/

      # ==========================================
      # STEP 6: Security Scan of Build Artifacts
      # ==========================================
      - name: ðŸ”’ Security Scan - Check for Exposed Secrets
        run: |
          echo "ðŸ” Scanning build artifacts for exposed secrets..."

          # Check for common secret patterns in built files
          if grep -r "sk_live_\|sk_test_" dist/ 2>/dev/null; then
            echo "âŒ WARNING: Potential API keys found in build artifacts!"
            echo "Please review the build output for exposed secrets."
            exit 1
          fi

          # Check for sensitive environment variable patterns
          if grep -r "SECRET\|PASSWORD\|PRIVATE_KEY" dist/ 2>/dev/null | grep -v "VITE_"; then
            echo "âš ï¸  Potential sensitive data found in build."
            echo "This may be a false positive, but please review."
          fi

          echo "âœ… Security scan completed - No obvious secrets detected"

      # ==========================================
      # STEP 7: Build Artifact Validation
      # ==========================================
      - name: âœ… Validate Build Artifacts
        run: |
          echo "ðŸ” Validating build artifacts..."

          # Check file sizes to ensure build is not empty
          INDEX_SIZE=$(stat -c%s "dist/index.html" 2>/dev/null || stat -f%z "dist/index.html")
          echo "index.html size: $INDEX_SIZE bytes"

          if [ "$INDEX_SIZE" -lt 100 ]; then
            echo "âŒ index.html is suspiciously small - build may have failed"
            exit 1
          fi

          # Check for essential assets
          if [ ! -d "dist/assets" ]; then
            echo "âš ï¸  No assets directory found - this may be expected for minimal builds"
          fi

          echo "âœ… Build artifacts validated successfully"

      # ==========================================
      # STEP 8: Configure GitHub Pages
      # ==========================================
      - name: âš™ï¸ Configure GitHub Pages
        uses: actions/configure-pages@v5

      # ==========================================
      # STEP 9: Upload Build Artifacts
      # ==========================================
      - name: ðŸ“¤ Upload Build Artifacts
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'
          retention-days: 7

      # ==========================================
      # STEP 10: Deploy to GitHub Pages
      # ==========================================
      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # ==========================================
      # STEP 11: Post-Deployment Verification
      # ==========================================
      - name: ðŸ” Verify Deployment Health
        if: success()
        run: |
          echo "ðŸ” Verifying deployment health..."

          # Wait for deployment to propagate
          echo "â³ Waiting 30 seconds for deployment to propagate..."
          sleep 30

          # Get the deployed URL
          DEPLOYED_URL="${{ steps.deployment.outputs.page_url }}"
          echo "Deployed URL: $DEPLOYED_URL"

          # Test if the site is accessible
          HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}" "$DEPLOYED_URL" || echo "000")
          echo "HTTP Response Code: $HTTP_CODE"

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Deployment is live and accessible"
          elif [ "$HTTP_CODE" = "000" ]; then
            echo "âš ï¸  Could not connect to deployment URL - it may take a few minutes to propagate"
          else
            echo "âš ï¸  Unexpected HTTP response code: $HTTP_CODE"
          fi

          echo "ðŸŒ Custom Domain: https://iku-cabalactiva.com"
          echo "ðŸ“Š Deployment completed successfully!"

      # ==========================================
      # STEP 12: Deployment Summary
      # ==========================================
      - name: ðŸ“‹ Deployment Summary
        if: always()
        run: |
          echo "## ðŸŒŸ IKU CABALA ACTIVA - Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Run**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Pages**: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Custom Domain**: https://iku-cabalactiva.com" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Environment variables injected from GitHub Secrets" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No sensitive data exposed in build artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… HTTPS enforced via GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Automated deployment for IKU CÃ¡bala Activa - Herramientas Espirituales del Maestro Isaac BenzaquÃ©n*" >> $GITHUB_STEP_SUMMARY
